
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>cwhSReachSetDemo</title><meta name="generator" content="MATLAB 9.3"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2018-10-22"><meta name="DC.source" content="cwhSReachSetDemo.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Verification of satellite rendezvous problem via SReachSet This example will</a></li><li><a href="#2">Problem formulation: Spacecraft motion via CWH dynamics</a></li><li><a href="#4">Dynamics model for the deputy relative to the chief spacecraft The relative</a></li><li><a href="#5">System definition</a></li><li><a href="#6">Methods to run</a></li><li><a href="#7">Target tube construction --- reach-avoid specification</a></li><li><a href="#9">Preparation for set computation</a></li><li><a href="#10">CC (Linear program approach)</a></li><li><a href="#11">Fourier transform (Genz's algorithm and MATLAB's patternsearch)</a></li><li><a href="#12">Preparation for Monte-Carlo simulations of the optimal controllers</a></li><li><a href="#13">Plotting and Monte-Carlo simulation-based validation</a></li><li><a href="#14">Reporting solution times</a></li><li><a href="#15">Helper functions</a></li></ul></div><h2 id="1">Verification of satellite rendezvous problem via SReachSet This example will</h2><pre class="codeinput"><span class="comment">%demonstrate the use of SReachTools in verification of stochastic</span>
<span class="comment">%continuous-state discrete-time linear time-invariant (LTI) systems.</span>
<span class="comment">%</span>
<span class="comment">% Specifically, we will discuss how SReachTools can use Fourier transforms</span>
<span class="comment">% (&lt;http://www.math.wsu.edu/faculty/genz/software/matlab/qsimvnv.m Genz's</span>
<span class="comment">% algorithm&gt; and MATLAB's patternsearch), convex chance constraints, and</span>
<span class="comment">% Lagrangian methods to construct underapproximative stochastic reach sets.</span>
<span class="comment">%</span>
<span class="comment">% Our approaches is grid-free and recursion-free resulting in highly scalable</span>
<span class="comment">% solutions, especially for Gaussian-perturbed LTI systems.</span>
<span class="comment">%</span>
<span class="comment">% This Live Script is part of the SReachTools toolbox. License for the use of</span>
<span class="comment">% this function is given in</span>
<span class="comment">% &lt;https://github.com/unm-hscl/SReachTools/blob/master/LICENSE</span>
<span class="comment">% https://github.com/unm-hscl/SReachTools/blob/master/LICENSE&gt;.</span>

<span class="comment">% Prescript running</span>
close <span class="string">all</span>;
<span class="comment">% clc;</span>
clearvars;
srtinit
</pre><h2 id="2">Problem formulation: Spacecraft motion via CWH dynamics</h2><p>We consider both the spacecrafts, referred to as the deputy spacecraft and the chief spacecraft, to be in the same circular orbit. In this example, we will consider the problem of verification for the spacecraft rendezvous problem, i.e., identify all the initial states from which the deputy can can rendezvous with the chief while staying within the line-of-sight cone with a likelihood above a user-specified threshold.</p><p><img vspace="5" hspace="5" src="cwh_sketch.png" alt=""> </p><h2 id="4">Dynamics model for the deputy relative to the chief spacecraft The relative</h2><pre class="codeinput"><span class="comment">%planar dynamics of the deputy with respect to the chief are described by the</span>
<span class="comment">%&lt;https://doi.org/10.1109/CDC.2013.6760626 Clohessy-Wiltshire-Hill (CWH)</span>
<span class="comment">%equations,&gt;</span>
<span class="comment">%</span>
<span class="comment">% $$\ddot{x} - 3 \omega x - 2 \omega \dot{y} = \frac{F_{x}}{m_{d}}$$</span>
<span class="comment">%</span>
<span class="comment">% $$            \ddot{y} + 2 \omega \dot{x} = \frac{F_{y}}{m_{d}}$$</span>
<span class="comment">%</span>
<span class="comment">% where the position of the deputy relative to the chief is $x,y \in</span>
<span class="comment">% \mathbf{R}$, $\omega = \sqrt{\frac{\mu}{R_{0}^{3}}}$ is the orbital frequency,</span>
<span class="comment">% $\mu$ is the gravitational constant, and $R_{0}$ is the orbital radius of the</span>
<span class="comment">% chief spacecraft.  We define the state as $\overline{x} = {[x\ y\ \dot{x}\</span>
<span class="comment">% \dot{y}]}^\top \in \mathbf{R}^{4}$ which is the position and velocity of the</span>
<span class="comment">% deputy relative to the chief along $\mathrm{x}$- and $\mathrm{y}$- axes, and</span>
<span class="comment">% the input as $\overline{u} = {[F_{x}\ F_{y}]}^\top \in</span>
<span class="comment">% \mathcal{U}\subset\mathbf{R}^{2}$.</span>
<span class="comment">%</span>
<span class="comment">% We will discretize the CWH dynamics in time, via zero-order hold, to obtain</span>
<span class="comment">% the discrete-time linear time-invariant system and add a Gaussian disturbance</span>
<span class="comment">% to account for the modeling uncertainties and the disturbance forces,</span>
<span class="comment">%</span>
<span class="comment">% $$\overline{x}_{k+1} = A \overline{x}_{k} + B \overline{u}_{k} +</span>
<span class="comment">% \overline{w}_{k}$$</span>
<span class="comment">%</span>
<span class="comment">% with $\overline{w}_{k} \in \mathbf{R}^{4}$ as an IID Gaussian zero-mean</span>
<span class="comment">% random process with a known covariance matrix $\Sigma_{\overline{w}}$.</span>
</pre><h2 id="5">System definition</h2><pre class="codeinput">umax = 0.1;
mean_disturbance = zeros(4,1);
covariance_disturbance = diag([1e-4, 1e-4, 5e-8, 5e-8]);
<span class="comment">% Define the CWH (planar) dynamics of the deputy spacecraft relative to the</span>
<span class="comment">% chief spacecraft as a LtiSystem object</span>
sys = getCwhLtiSystem(4, Polyhedron(<span class="string">'lb'</span>, -umax*ones(2,1), <span class="keyword">...</span>
                                        <span class="string">'ub'</span>,  umax*ones(2,1)), <span class="keyword">...</span>
       RandomVector(<span class="string">'Gaussian'</span>, mean_disturbance,covariance_disturbance));
</pre><h2 id="6">Methods to run</h2><pre class="codeinput">ft_run = 1;
cc_open_run = 1;
</pre><h2 id="7">Target tube construction --- reach-avoid specification</h2><pre class="codeinput">time_horizon = 5;          <span class="comment">% Stay within a line of sight cone for 4 time steps and</span>
                         <span class="comment">% reach the target at t=5% Safe Set --- LoS cone</span>
<span class="comment">% Safe set definition --- LoS cone |x|&lt;=y and y\in[0,ymax] and |vx|&lt;=vxmax and</span>
<span class="comment">% |vy|&lt;=vymax</span>
ymax = 2;
vxmax = 0.5;
vymax = 0.5;
A_safe_set = [1, 1, 0, 0;
             -1, 1, 0, 0;
              0, -1, 0, 0;
              0, 0, 1,0;
              0, 0,-1,0;
              0, 0, 0,1;
              0, 0, 0,-1];
b_safe_set = [0;
              0;
              ymax;
              vxmax;
              vxmax;
              vymax;
              vymax];
safe_set = Polyhedron(A_safe_set, b_safe_set);
<span class="comment">% Target set --- Box [-0.1,0.1]x[-0.1,0]x[-0.01,0.01]x[-0.01,0.01]</span>
target_set = Polyhedron(<span class="string">'lb'</span>, [-0.1; -0.1; -0.01; -0.01], <span class="keyword">...</span>
                        <span class="string">'ub'</span>, [0.1; 0; 0.01; 0.01]);
target_tube = Tube(<span class="string">'reach-avoid'</span>,safe_set, target_set, time_horizon);
slice_at_vx_vy = zeros(2,1);
</pre><h2 id="9">Preparation for set computation</h2><pre class="codeinput">prob_thresh = 0.8;

n_dir_vecs = 10;
theta_vec = linspace(0, 2*pi, n_dir_vecs);
set_of_dir_vecs_ft = [cos(theta_vec);
                      sin(theta_vec);
                      zeros(2,n_dir_vecs)];
n_dir_vecs = 40;
theta_vec = linspace(0, 2*pi, n_dir_vecs);
set_of_dir_vecs_cc_open = [cos(theta_vec);
                           sin(theta_vec);
                           zeros(2,n_dir_vecs)];
init_safe_set_affine = Polyhedron(<span class="string">'He'</span>,[zeros(2,2) eye(2,2) slice_at_vx_vy]);
</pre><h2 id="10">CC (Linear program approach)</h2><pre class="codeinput"><span class="keyword">if</span> cc_open_run
    options = SReachSetOptions(<span class="string">'term'</span>, <span class="string">'chance-open'</span>, <span class="keyword">...</span>
        <span class="string">'set_of_dir_vecs'</span>, set_of_dir_vecs_cc_open, <span class="keyword">...</span>
        <span class="string">'init_safe_set_affine'</span>, init_safe_set_affine, <span class="keyword">...</span>
        <span class="string">'verbose'</span>, 1);
    timer_cc_open = tic;
    [polytope_cc_open, extra_info] = SReachSet(<span class="string">'term'</span>,<span class="string">'chance-open'</span>, sys, <span class="keyword">...</span>
        prob_thresh, target_tube, options);
    elapsed_time_cc_open = toc(timer_cc_open);
<span class="keyword">end</span>
</pre><pre class="codeoutput">Computing the polytope via a maximally safe initial state
Analyzing direction : 1/40
Analyzing direction : 2/40
Analyzing direction : 3/40
Analyzing direction : 4/40
Analyzing direction : 5/40
Analyzing direction : 6/40
Analyzing direction : 7/40
Analyzing direction : 8/40
Analyzing direction : 9/40
Analyzing direction :10/40
Analyzing direction :11/40
Analyzing direction :12/40
Analyzing direction :13/40
Analyzing direction :14/40
Analyzing direction :15/40
Analyzing direction :16/40
Analyzing direction :17/40
Analyzing direction :18/40
Analyzing direction :19/40
Analyzing direction :20/40
Analyzing direction :21/40
Analyzing direction :22/40
Analyzing direction :23/40
Analyzing direction :24/40
Analyzing direction :25/40
Analyzing direction :26/40
Analyzing direction :27/40
Analyzing direction :28/40
Analyzing direction :29/40
Analyzing direction :30/40
Analyzing direction :31/40
Analyzing direction :32/40
Analyzing direction :33/40
Analyzing direction :34/40
Analyzing direction :35/40
Analyzing direction :36/40
Analyzing direction :37/40
Analyzing direction :38/40
Analyzing direction :39/40
Analyzing direction :40/40
Computing the polytope via the Chebyshev center
Analyzing direction : 1/40
Analyzing direction : 2/40
Analyzing direction : 3/40
Analyzing direction : 4/40
Analyzing direction : 5/40
Analyzing direction : 6/40
Analyzing direction : 7/40
Analyzing direction : 8/40
Analyzing direction : 9/40
Analyzing direction :10/40
Analyzing direction :11/40
Analyzing direction :12/40
Analyzing direction :13/40
Analyzing direction :14/40
Analyzing direction :15/40
Analyzing direction :16/40
Analyzing direction :17/40
Analyzing direction :18/40
Analyzing direction :19/40
Analyzing direction :20/40
Analyzing direction :21/40
Analyzing direction :22/40
Analyzing direction :23/40
Analyzing direction :24/40
Analyzing direction :25/40
Analyzing direction :26/40
Analyzing direction :27/40
Analyzing direction :28/40
Analyzing direction :29/40
Analyzing direction :30/40
Analyzing direction :31/40
Analyzing direction :32/40
Analyzing direction :33/40
Analyzing direction :34/40
Analyzing direction :35/40
Analyzing direction :36/40
Analyzing direction :37/40
Analyzing direction :38/40
Analyzing direction :39/40
Analyzing direction :40/40
</pre><h2 id="11">Fourier transform (Genz's algorithm and MATLAB's patternsearch)</h2><pre class="codeinput"><span class="keyword">if</span> ft_run
    options = SReachSetOptions(<span class="string">'term'</span>, <span class="string">'genzps-open'</span>, <span class="keyword">...</span>
        <span class="string">'set_of_dir_vecs'</span>, set_of_dir_vecs_ft, <span class="keyword">...</span>
        <span class="string">'init_safe_set_affine'</span>, init_safe_set_affine, <span class="string">'verbose'</span>, 1);
    timer_ft = tic;
    polytope_ft = SReachSet(<span class="string">'term'</span>,<span class="string">'genzps-open'</span>, sys, prob_thresh, <span class="keyword">...</span>
        target_tube, options);
    elapsed_time_ft = toc(timer_ft);
<span class="keyword">end</span>
</pre><pre class="codeoutput">Polytopic underapproximation exists for alpha = 0.80 since W(x_max) = 0.866.

Analyzing direction : 1/10 | Upper bound of theta: 0.64
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8660  |  0.00e+00  |  0.00e+00  |  6.45e-01  |  5.20e-03  | Infeasible (0.001) 
  0.8050  |  1.61e-01  |  0.00e+00  |  3.22e-01  |  5.78e-03  | Feasible 
  0.8050  |  2.42e-01  |  1.61e-01  |  3.22e-01  |  8.38e-03  | Feasible 
  0.8050  |  2.82e-01  |  2.42e-01  |  3.22e-01  |  8.38e-03  | Feasible 
  0.8050  |  3.02e-01  |  2.82e-01  |  3.22e-01  |  9.20e-03  | Feasible 
  0.8050  |  3.12e-01  |  3.02e-01  |  3.22e-01  |  9.20e-03  | Feasible 
  0.8050  |  3.17e-01  |  3.12e-01  |  3.22e-01  |  9.20e-03  | Feasible 
Analyzing direction : 2/10 | Upper bound of theta: 0.46
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8050  |  2.29e-01  |  0.00e+00  |  4.58e-01  |  4.53e-03  | Feasible 
  0.8050  |  3.43e-01  |  2.29e-01  |  4.58e-01  |  1.07e-02  | Feasible 
  0.8050  |  4.00e-01  |  3.43e-01  |  4.58e-01  |  1.08e-02  | Feasible 
  0.8050  |  4.29e-01  |  4.00e-01  |  4.58e-01  |  1.08e-02  | Feasible 
  0.8050  |  4.43e-01  |  4.29e-01  |  4.58e-01  |  1.11e-02  | Feasible 
  0.8050  |  4.50e-01  |  4.43e-01  |  4.58e-01  |  1.41e-02  | Feasible 
Analyzing direction : 3/10 | Upper bound of theta: 0.56
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8050  |  2.78e-01  |  0.00e+00  |  5.56e-01  |  5.14e-03  | Feasible 
  0.8050  |  4.17e-01  |  2.78e-01  |  5.56e-01  |  8.28e-03  | Feasible 
  0.8050  |  4.87e-01  |  4.17e-01  |  5.56e-01  |  1.23e-02  | Feasible 
  0.8050  |  5.22e-01  |  4.87e-01  |  5.56e-01  |  1.29e-02  | Feasible 
  0.8050  |  5.39e-01  |  5.22e-01  |  5.56e-01  |  1.29e-02  | Feasible 
  0.8050  |  5.48e-01  |  5.39e-01  |  5.56e-01  |  1.02e-02  | Feasible 
Analyzing direction : 4/10 | Upper bound of theta: 0.47
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8050  |  2.36e-01  |  0.00e+00  |  4.72e-01  |  9.77e-03  | Feasible 
  0.8050  |  3.54e-01  |  2.36e-01  |  4.72e-01  |  1.28e-02  | Feasible 
  0.8050  |  4.13e-01  |  3.54e-01  |  4.72e-01  |  1.26e-02  | Feasible 
  0.8050  |  4.42e-01  |  4.13e-01  |  4.72e-01  |  1.72e-02  | Feasible 
  0.8050  |  4.57e-01  |  4.42e-01  |  4.72e-01  |  1.44e-02  | Feasible 
  0.8050  |  4.65e-01  |  4.57e-01  |  4.72e-01  |  1.14e-02  | Feasible 
Analyzing direction : 5/10 | Upper bound of theta: 0.50
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8660  |  0.00e+00  |  0.00e+00  |  5.03e-01  |  5.20e-03  | Infeasible (0.001) 
  0.8050  |  1.26e-01  |  0.00e+00  |  2.51e-01  |  1.12e-02  | Feasible 
  0.8050  |  1.89e-01  |  1.26e-01  |  2.51e-01  |  1.15e-02  | Feasible 
  0.8050  |  2.20e-01  |  1.89e-01  |  2.51e-01  |  1.15e-02  | Feasible 
  0.8050  |  2.36e-01  |  2.20e-01  |  2.51e-01  |  1.15e-02  | Feasible 
  0.8050  |  2.44e-01  |  2.36e-01  |  2.51e-01  |  1.15e-02  | Feasible 
Analyzing direction : 6/10 | Upper bound of theta: 1.08
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8660  |  0.00e+00  |  0.00e+00  |  1.08e+00  |  5.20e-03  | Infeasible (0.001) 
  0.8660  |  0.00e+00  |  0.00e+00  |  5.39e-01  |  5.20e-03  | Infeasible (0.001) 
  0.8050  |  1.35e-01  |  0.00e+00  |  2.70e-01  |  9.71e-03  | Feasible 
  0.8050  |  2.02e-01  |  1.35e-01  |  2.70e-01  |  2.02e-02  | Feasible 
  0.8050  |  2.36e-01  |  2.02e-01  |  2.70e-01  |  2.02e-02  | Feasible 
  0.8050  |  2.53e-01  |  2.36e-01  |  2.70e-01  |  2.18e-02  | Feasible 
  0.8050  |  2.61e-01  |  2.53e-01  |  2.70e-01  |  2.18e-02  | Feasible 
Analyzing direction : 7/10 | Upper bound of theta: 1.57
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8660  |  0.00e+00  |  0.00e+00  |  1.57e+00  |  5.20e-03  | Infeasible (0.001) 
  0.8660  |  0.00e+00  |  0.00e+00  |  7.83e-01  |  5.20e-03  | Infeasible (0.001) 
  0.8050  |  1.96e-01  |  0.00e+00  |  3.91e-01  |  1.75e-02  | Feasible 
  0.8050  |  2.93e-01  |  1.96e-01  |  3.91e-01  |  2.23e-02  | Feasible 
  0.8050  |  3.42e-01  |  2.93e-01  |  3.91e-01  |  2.40e-02  | Feasible 
  0.8050  |  3.67e-01  |  3.42e-01  |  3.91e-01  |  2.46e-02  | Feasible 
  0.8050  |  3.79e-01  |  3.67e-01  |  3.91e-01  |  2.42e-02  | Feasible 
  0.8050  |  3.85e-01  |  3.79e-01  |  3.91e-01  |  2.47e-02  | Feasible 
Analyzing direction : 8/10 | Upper bound of theta: 1.38
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8660  |  0.00e+00  |  0.00e+00  |  1.38e+00  |  5.20e-03  | Infeasible (0.001) 
  0.8660  |  0.00e+00  |  0.00e+00  |  6.88e-01  |  5.20e-03  | Infeasible (0.001) 
  0.8050  |  1.72e-01  |  0.00e+00  |  3.44e-01  |  1.19e-02  | Feasible 
  0.8050  |  2.58e-01  |  1.72e-01  |  3.44e-01  |  2.91e-02  | Feasible 
  0.8050  |  3.01e-01  |  2.58e-01  |  3.44e-01  |  3.24e-02  | Feasible 
  0.8050  |  3.23e-01  |  3.01e-01  |  3.44e-01  |  3.26e-02  | Feasible 
  0.8050  |  3.33e-01  |  3.23e-01  |  3.44e-01  |  3.60e-02  | Feasible 
  0.8050  |  3.39e-01  |  3.33e-01  |  3.44e-01  |  3.60e-02  | Feasible 
Analyzing direction : 9/10 | Upper bound of theta: 2.11
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8660  |  0.00e+00  |  0.00e+00  |  2.11e+00  |  5.20e-03  | Infeasible (0.001) 
  0.8660  |  0.00e+00  |  0.00e+00  |  1.05e+00  |  5.20e-03  | Infeasible (0.001) 
  0.8660  |  0.00e+00  |  0.00e+00  |  5.27e-01  |  5.20e-03  | Infeasible (0.001) 
  0.8050  |  1.32e-01  |  0.00e+00  |  2.64e-01  |  2.00e-02  | Feasible 
  0.8050  |  1.98e-01  |  1.32e-01  |  2.64e-01  |  2.37e-02  | Feasible 
  0.8050  |  2.31e-01  |  1.98e-01  |  2.64e-01  |  2.06e-02  | Feasible 
  0.8050  |  2.47e-01  |  2.31e-01  |  2.64e-01  |  2.06e-02  | Feasible 
  0.8050  |  2.55e-01  |  2.47e-01  |  2.64e-01  |  2.06e-02  | Feasible 
Analyzing direction :10/10 | Upper bound of theta: 0.64
OptRAProb |  OptTheta  |  LB_theta  |  UB_theta  |  OptInp^2  | Exit reason
  0.8660  |  0.00e+00  |  0.00e+00  |  6.45e-01  |  5.20e-03  | Infeasible (0.001) 
  0.8050  |  1.61e-01  |  0.00e+00  |  3.22e-01  |  5.78e-03  | Feasible 
  0.8050  |  2.42e-01  |  1.61e-01  |  3.22e-01  |  8.38e-03  | Feasible 
  0.8050  |  2.82e-01  |  2.42e-01  |  3.22e-01  |  8.38e-03  | Feasible 
  0.8050  |  3.02e-01  |  2.82e-01  |  3.22e-01  |  9.20e-03  | Feasible 
  0.8050  |  3.12e-01  |  3.02e-01  |  3.22e-01  |  9.20e-03  | Feasible 
  0.8050  |  3.17e-01  |  3.12e-01  |  3.22e-01  |  9.20e-03  | Feasible 
</pre><h2 id="12">Preparation for Monte-Carlo simulations of the optimal controllers</h2><p>Monte-Carlo simulation parameters</p><pre class="codeinput">n_mcarlo_sims = 1e5;
n_sims_to_plot = 5;
</pre><h2 id="13">Plotting and Monte-Carlo simulation-based validation</h2><pre class="codeinput">figure(1);
clf
box <span class="string">on</span>;
hold <span class="string">on</span>;
plot(safe_set.slice([3,4], slice_at_vx_vy), <span class="string">'color'</span>, <span class="string">'y'</span>);
plot(target_set.slice([3,4], slice_at_vx_vy), <span class="string">'color'</span>, <span class="string">'g'</span>);
legend_cell = {<span class="string">'Safe set'</span>,<span class="string">'Target set'</span>};
<span class="keyword">if</span> exist(<span class="string">'polytope_cc_open'</span>,<span class="string">'var'</span>)
    plot(polytope_cc_open.slice([3,4], slice_at_vx_vy), <span class="string">'color'</span>,<span class="string">'m'</span>,<span class="string">'alpha'</span>,1);
    legend_cell{end+1} = <span class="string">'Underapprox. polytope (chance-open)'</span>;
<span class="keyword">else</span>
    polytope_cc_open = Polyhedron();
    elapsed_time_cc_open = NaN;
<span class="keyword">end</span>
<span class="keyword">if</span> exist(<span class="string">'polytope_ft'</span>,<span class="string">'var'</span>)
    plot(polytope_ft.slice([3,4], slice_at_vx_vy), <span class="string">'color'</span>,<span class="string">'b'</span>,<span class="string">'alpha'</span>,1);
    legend_cell{end+1} = <span class="string">'Underapprox. polytope (genzps-open)'</span>;
<span class="keyword">else</span>
    polytope_ft = Polyhedron();
    elapsed_time_ft = NaN;
<span class="keyword">end</span>
direction_index_to_plot = 30;
<span class="keyword">if</span> ~isEmptySet(polytope_cc_open)
    init_state = extra_info(2).vertices_underapprox_polytope(:,direction_index_to_plot);
    input_vec = extra_info(2).opt_input_vec_at_vertices(:,direction_index_to_plot);
    opt_reach_avoid = extra_info(2).opt_reach_prob_i(direction_index_to_plot);

    concat_state_realization = generateMonteCarloSims(<span class="keyword">...</span>
            n_mcarlo_sims, <span class="keyword">...</span>
            sys, <span class="keyword">...</span>
            init_state, <span class="keyword">...</span>
            time_horizon, <span class="keyword">...</span>
            input_vec);

    <span class="comment">% Check if the location is within the target_set or not</span>
    mcarlo_result = target_tube.contains([repmat(init_state,1,n_mcarlo_sims);
                                          concat_state_realization]);
    [legend_cell] = plotMonteCarlo(<span class="string">' (chance-open)'</span>, mcarlo_result, <span class="keyword">...</span>
        concat_state_realization, n_mcarlo_sims, n_sims_to_plot, <span class="keyword">...</span>
        sys.state_dim,init_state, legend_cell);
<span class="keyword">end</span>
legend(legend_cell, <span class="string">'Location'</span>,<span class="string">'South'</span>);
xlabel(<span class="string">'$x$'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>);
ylabel(<span class="string">'$y$'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>);
</pre><img vspace="5" hspace="5" src="cwhSReachSetDemo_01.png" alt=""> <h2 id="14">Reporting solution times</h2><pre class="codeinput"><span class="keyword">if</span> any(isnan([elapsed_time_ft, elapsed_time_cc_open]))
    disp(<span class="string">'Skipped items would show up as NaN'</span>);
<span class="keyword">end</span>
fprintf(<span class="string">'Elapsed time: (genzps-open) %1.3f | (chance-open) %1.3f seconds\n'</span>, <span class="keyword">...</span>
    elapsed_time_ft, elapsed_time_cc_open);
</pre><pre class="codeoutput">Elapsed time: (genzps-open) 1276.681 | (chance-open) 36.257 seconds
</pre><h2 id="15">Helper functions</h2><p>Plotting function</p><pre class="codeinput"><span class="keyword">function</span> [legend_cell] = plotMonteCarlo(method_str, mcarlo_result, <span class="keyword">...</span>
    concat_state_realization, n_mcarlo_sims, n_sims_to_plot, state_dim, <span class="keyword">...</span>
    initial_state, legend_cell)
<span class="comment">% Plots a selection of Monte-Carlo simulations on top of the plot</span>

    green_legend_updated = 0;
    red_legend_updated = 0;
    traj_indices = floor(n_mcarlo_sims*rand(1,n_sims_to_plot));
    <span class="keyword">for</span> realization_index = traj_indices
        <span class="comment">% Check if the trajectory satisfies the reach-avoid objective</span>
        <span class="keyword">if</span> mcarlo_result(realization_index)
            <span class="comment">% Assign green triangle as the marker</span>
            markerString = <span class="string">'g^-'</span>;
        <span class="keyword">else</span>
            <span class="comment">% Assign red asterisk as the marker</span>
            markerString = <span class="string">'r*-'</span>;
        <span class="keyword">end</span>
        <span class="comment">% Create [x(t_1) x(t_2)... x(t_N)]</span>
        reshaped_X_vector = reshape(<span class="keyword">...</span>
            concat_state_realization(:,realization_index), state_dim,[]);
        <span class="comment">% This realization is to be plotted</span>
        h = plot([initial_state(1), reshaped_X_vector(1,:)], <span class="keyword">...</span>
                 [initial_state(2), reshaped_X_vector(2,:)], <span class="keyword">...</span>
                 markerString, <span class="string">'MarkerSize'</span>,10);
        <span class="comment">% Update the legends if the first else, disable</span>
        <span class="keyword">if</span> strcmp(markerString,<span class="string">'g^-'</span>)
            <span class="keyword">if</span> green_legend_updated
                h.Annotation.LegendInformation.IconDisplayStyle = <span class="string">'off'</span>;
            <span class="keyword">else</span>
                green_legend_updated = 1;
                legend_cell{end+1} = strcat(<span class="string">'Good trajectory '</span>, method_str);
            <span class="keyword">end</span>
        <span class="keyword">elseif</span> strcmp(markerString,<span class="string">'r*-'</span>)
            <span class="keyword">if</span> red_legend_updated
                h.Annotation.LegendInformation.IconDisplayStyle = <span class="string">'off'</span>;
            <span class="keyword">else</span>
                red_legend_updated = 1;
                legend_cell{end+1} = strcat(<span class="string">'Bad trajectory '</span>, method_str);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2017b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Verification of satellite rendezvous problem via SReachSet This example will
%demonstrate the use of SReachTools in verification of stochastic
%continuous-state discrete-time linear time-invariant (LTI) systems.
% 
% Specifically, we will discuss how SReachTools can use Fourier transforms
% (<http://www.math.wsu.edu/faculty/genz/software/matlab/qsimvnv.m Genz's
% algorithm> and MATLAB's patternsearch), convex chance constraints, and
% Lagrangian methods to construct underapproximative stochastic reach sets.
%
% Our approaches is grid-free and recursion-free resulting in highly scalable
% solutions, especially for Gaussian-perturbed LTI systems. 
%
% This Live Script is part of the SReachTools toolbox. License for the use of
% this function is given in
% <https://github.com/unm-hscl/SReachTools/blob/master/LICENSE
% https://github.com/unm-hscl/SReachTools/blob/master/LICENSE>.

% Prescript running
close all;
% clc;
clearvars;
srtinit
%% Problem formulation: Spacecraft motion via CWH dynamics
% We consider both the spacecrafts, referred to as the deputy spacecraft and 
% the chief spacecraft, to be in the same circular orbit. In this example, we 
% will consider the problem of verification for the spacecraft rendezvous
% problem, i.e., identify all the initial states from which the deputy can can
% rendezvous with the chief while staying within the line-of-sight cone with
% a likelihood above a user-specified threshold.
%%
% <<cwh_sketch.png>>
%% Dynamics model for the deputy relative to the chief spacecraft The relative
%planar dynamics of the deputy with respect to the chief are described by the
%<https://doi.org/10.1109/CDC.2013.6760626 Clohessy-Wiltshire-Hill (CWH)
%equations,> 
% 
% $$\ddot{x} - 3 \omega x - 2 \omega \dot{y} = \frac{F_{x}}{m_{d}}$$
% 
% $$            \ddot{y} + 2 \omega \dot{x} = \frac{F_{y}}{m_{d}}$$ 
% 
% where the position of the deputy relative to the chief is $x,y \in
% \mathbf{R}$, $\omega = \sqrt{\frac{\mu}{R_{0}^{3}}}$ is the orbital frequency,
% $\mu$ is the gravitational constant, and $R_{0}$ is the orbital radius of the
% chief spacecraft.  We define the state as $\overline{x} = {[x\ y\ \dot{x}\
% \dot{y}]}^\top \in \mathbf{R}^{4}$ which is the position and velocity of the
% deputy relative to the chief along $\mathrm{x}$- and $\mathrm{y}$- axes, and
% the input as $\overline{u} = {[F_{x}\ F_{y}]}^\top \in
% \mathcal{U}\subset\mathbf{R}^{2}$. 
% 
% We will discretize the CWH dynamics in time, via zero-order hold, to obtain
% the discrete-time linear time-invariant system and add a Gaussian disturbance
% to account for the modeling uncertainties and the disturbance forces,
% 
% $$\overline{x}_{k+1} = A \overline{x}_{k} + B \overline{u}_{k} +
% \overline{w}_{k}$$
% 
% with $\overline{w}_{k} \in \mathbf{R}^{4}$ as an IID Gaussian zero-mean 
% random process with a known covariance matrix $\Sigma_{\overline{w}}$. 
 
%% System definition
umax = 0.1;
mean_disturbance = zeros(4,1);
covariance_disturbance = diag([1e-4, 1e-4, 5e-8, 5e-8]);
% Define the CWH (planar) dynamics of the deputy spacecraft relative to the
% chief spacecraft as a LtiSystem object
sys = getCwhLtiSystem(4, Polyhedron('lb', -umax*ones(2,1), ...
                                        'ub',  umax*ones(2,1)), ...
       RandomVector('Gaussian', mean_disturbance,covariance_disturbance));

%% Methods to run   
ft_run = 1;
cc_open_run = 1;

%% Target tube construction REPLACE_WITH_DASH_DASH- reach-avoid specification
time_horizon = 5;          % Stay within a line of sight cone for 4 time steps and 
                         % reach the target at t=5% Safe Set REPLACE_WITH_DASH_DASH- LoS cone
% Safe set definition REPLACE_WITH_DASH_DASH- LoS cone |x|<=y and y\in[0,ymax] and |vx|<=vxmax and 
% |vy|<=vymax
ymax = 2;
vxmax = 0.5;
vymax = 0.5;
A_safe_set = [1, 1, 0, 0;           
             -1, 1, 0, 0; 
              0, -1, 0, 0;
              0, 0, 1,0;
              0, 0,-1,0;
              0, 0, 0,1;
              0, 0, 0,-1];
b_safe_set = [0;
              0;
              ymax;
              vxmax;
              vxmax;
              vymax;
              vymax];
safe_set = Polyhedron(A_safe_set, b_safe_set);
% Target set REPLACE_WITH_DASH_DASH- Box [-0.1,0.1]x[-0.1,0]x[-0.01,0.01]x[-0.01,0.01]
target_set = Polyhedron('lb', [-0.1; -0.1; -0.01; -0.01], ...
                        'ub', [0.1; 0; 0.01; 0.01]);
target_tube = Tube('reach-avoid',safe_set, target_set, time_horizon);                    
slice_at_vx_vy = zeros(2,1);
%%

%% Preparation for set computation
prob_thresh = 0.8;

n_dir_vecs = 10;
theta_vec = linspace(0, 2*pi, n_dir_vecs);
set_of_dir_vecs_ft = [cos(theta_vec);
                      sin(theta_vec);
                      zeros(2,n_dir_vecs)];
n_dir_vecs = 40;
theta_vec = linspace(0, 2*pi, n_dir_vecs);
set_of_dir_vecs_cc_open = [cos(theta_vec);
                           sin(theta_vec);
                           zeros(2,n_dir_vecs)];
init_safe_set_affine = Polyhedron('He',[zeros(2,2) eye(2,2) slice_at_vx_vy]);

%% CC (Linear program approach)
if cc_open_run
    options = SReachSetOptions('term', 'chance-open', ...
        'set_of_dir_vecs', set_of_dir_vecs_cc_open, ...
        'init_safe_set_affine', init_safe_set_affine, ...
        'verbose', 1);
    timer_cc_open = tic;
    [polytope_cc_open, extra_info] = SReachSet('term','chance-open', sys, ...
        prob_thresh, target_tube, options);  
    elapsed_time_cc_open = toc(timer_cc_open);
end

%% Fourier transform (Genz's algorithm and MATLAB's patternsearch)
if ft_run
    options = SReachSetOptions('term', 'genzps-open', ...
        'set_of_dir_vecs', set_of_dir_vecs_ft, ...
        'init_safe_set_affine', init_safe_set_affine, 'verbose', 1);
    timer_ft = tic;
    polytope_ft = SReachSet('term','genzps-open', sys, prob_thresh, ...
        target_tube, options);  
    elapsed_time_ft = toc(timer_ft);
end

%% Preparation for Monte-Carlo simulations of the optimal controllers
% Monte-Carlo simulation parameters
n_mcarlo_sims = 1e5;
n_sims_to_plot = 5;

%% Plotting and Monte-Carlo simulation-based validation
figure(1);
clf
box on;
hold on;
plot(safe_set.slice([3,4], slice_at_vx_vy), 'color', 'y');
plot(target_set.slice([3,4], slice_at_vx_vy), 'color', 'g');
legend_cell = {'Safe set','Target set'};
if exist('polytope_cc_open','var')
    plot(polytope_cc_open.slice([3,4], slice_at_vx_vy), 'color','m','alpha',1);
    legend_cell{end+1} = 'Underapprox. polytope (chance-open)';
else
    polytope_cc_open = Polyhedron();
    elapsed_time_cc_open = NaN;
end
if exist('polytope_ft','var')
    plot(polytope_ft.slice([3,4], slice_at_vx_vy), 'color','b','alpha',1);
    legend_cell{end+1} = 'Underapprox. polytope (genzps-open)';
else
    polytope_ft = Polyhedron();
    elapsed_time_ft = NaN;
end
direction_index_to_plot = 30;
if ~isEmptySet(polytope_cc_open)
    init_state = extra_info(2).vertices_underapprox_polytope(:,direction_index_to_plot);
    input_vec = extra_info(2).opt_input_vec_at_vertices(:,direction_index_to_plot);
    opt_reach_avoid = extra_info(2).opt_reach_prob_i(direction_index_to_plot);

    concat_state_realization = generateMonteCarloSims(...
            n_mcarlo_sims, ...
            sys, ...
            init_state, ...
            time_horizon, ...
            input_vec);        
    
    % Check if the location is within the target_set or not
    mcarlo_result = target_tube.contains([repmat(init_state,1,n_mcarlo_sims);
                                          concat_state_realization]);
    [legend_cell] = plotMonteCarlo(' (chance-open)', mcarlo_result, ...
        concat_state_realization, n_mcarlo_sims, n_sims_to_plot, ...
        sys.state_dim,init_state, legend_cell);
end
legend(legend_cell, 'Location','South');
xlabel('$x$','interpreter','latex');
ylabel('$y$','interpreter','latex');

%% Reporting solution times
if any(isnan([elapsed_time_ft, elapsed_time_cc_open]))
    disp('Skipped items would show up as NaN');
end
fprintf('Elapsed time: (genzps-open) %1.3f | (chance-open) %1.3f seconds\n', ...
    elapsed_time_ft, elapsed_time_cc_open);

%% Helper functions
% Plotting function
function [legend_cell] = plotMonteCarlo(method_str, mcarlo_result, ...
    concat_state_realization, n_mcarlo_sims, n_sims_to_plot, state_dim, ...
    initial_state, legend_cell)
% Plots a selection of Monte-Carlo simulations on top of the plot

    green_legend_updated = 0;
    red_legend_updated = 0;
    traj_indices = floor(n_mcarlo_sims*rand(1,n_sims_to_plot));
    for realization_index = traj_indices
        % Check if the trajectory satisfies the reach-avoid objective
        if mcarlo_result(realization_index)
            % Assign green triangle as the marker
            markerString = 'g^-';
        else
            % Assign red asterisk as the marker
            markerString = 'r*-';
        end
        % Create [x(t_1) x(t_2)... x(t_N)]
        reshaped_X_vector = reshape(...
            concat_state_realization(:,realization_index), state_dim,[]);
        % This realization is to be plotted
        h = plot([initial_state(1), reshaped_X_vector(1,:)], ...
                 [initial_state(2), reshaped_X_vector(2,:)], ...
                 markerString, 'MarkerSize',10);
        % Update the legends if the first else, disable
        if strcmp(markerString,'g^-')
            if green_legend_updated
                h.Annotation.LegendInformation.IconDisplayStyle = 'off';
            else
                green_legend_updated = 1;
                legend_cell{end+1} = strcat('Good trajectory ', method_str);
            end
        elseif strcmp(markerString,'r*-')
            if red_legend_updated
                h.Annotation.LegendInformation.IconDisplayStyle = 'off';
            else
                red_legend_updated = 1;
                legend_cell{end+1} = strcat('Bad trajectory ', method_str);
            end
        end
    end
end

##### SOURCE END #####
--></body></html>